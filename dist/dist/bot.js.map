{"version":3,"sources":["../bot.js"],"names":["_slicedToArray","sliceIterator","arr","i","_arr","_n","_d","_e","undefined","_i","Symbol","iterator","_s","next","done","push","value","length","err","Array","isArray","Object","TypeError","_server","require","_bodyParser","_bodyParser2","_interopRequireDefault","_config","_config2","_crypto","_crypto2","_underscore","_","_interopRequireWildcard","_requestPromise","_requestPromise2","obj","__esModule","newObj","key","prototype","hasOwnProperty","call","default","APP_SECRET","process","env","MESSENGER_APP_SECRET","get","VALIDATION_TOKEN","MESSENGER_VALIDATION_TOKEN","PAGE_ACCESS_TOKEN","MESSENGER_PAGE_ACCESS_TOKEN","SERVER_URL","FACEBOOK_APP_ID","FACEBOOK_GRAPH","REDIRECT_URI","limit","console","error","exit","app","use","json","verify","verifyRequestSignature","listener","buffer","rules","Map","payloadRules","req","res","buf","signature","headers","elements","split","method","signatureHash","expectedHash","createHmac","update","digest","Error","receivedAuthentication","event","senderID","sender","id","recipientID","recipient","timeOfAuth","timestamp","parseInt","passThroughParam","optin","ref","log","sendTextMessage","receivedMessage","timeOfMessage","message","isEcho","is_echo","messageId","mid","appId","app_id","metadata","messageText","text","messageAttachments","attachments","quickReply","quick_reply","quickReplyPayload","payload","payloadFunction","includes","params","userListeners","existRule","isEmpty","keys","shift","type","callback","toLowerCase","forEach","defaultSearch","location","coordinates","_userListeners","_keys","_key","lat","lng","long","receivedDeliveryConfirmation","delivery","messageIDs","mids","watermark","sequenceNumber","seq","messageID","receivedPostback","timeOfPostback","postback","receivedMessageRead","read","receivedAccountLink","status","account_linking","authCode","authorization_code","callSendAPI","messageData","uri","qs","access_token","catch","testAPI","then","response","name","email","sendTypingOn","recipientId","sender_action","sendTypingOff","sendImageMessage","imageUrl","attachment","url","sendGifMessage","gifUrl","sendAudioMessage","audioUrl","sendVideoMessage","videoUrl","sendFileMessage","fileUrl","sendButtonMessage","buttons","template_type","sendGenericMessage","sendReceiptMessage","quick_replies","receiptId","Math","floor","random","sendQuickReplyMessage","sendReadReceipt","sendAccountLinking","findKeyStartsWith","map","str","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_iterator","_step","_step$value","startsWith","return","setListener","dataId","getListener","deleteListener","setDataBuffer","query","search","send","sendStatus","post","data","body","object","entry","pageEntry","pageID","timeOfEvent","time","messaging","messagingEvent","accountLinkingToken","redirectURI","redirectURISuccess","render","listen","module","exports","Parse"],"mappings":"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","file":"bot.js","sourcesContent":["'use strict';var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i[\"return\"])_i[\"return\"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");}};}();var _server=require('./server');var _bodyParser=require('body-parser');var _bodyParser2=_interopRequireDefault(_bodyParser);var _config=require('config');var _config2=_interopRequireDefault(_config);var _crypto=require('crypto');var _crypto2=_interopRequireDefault(_crypto);var _underscore=require('underscore');var _=_interopRequireWildcard(_underscore);var _requestPromise=require('request-promise');var _requestPromise2=_interopRequireDefault(_requestPromise);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}//import parseExpressHttpsRedirect from 'parse-express-https-redirect'\n// App Secret can be retrieved from the App Dashboard\nvar APP_SECRET=process.env.MESSENGER_APP_SECRET?process.env.MESSENGER_APP_SECRET:_config2.default.get('APP_SECRET');// Arbitrary value used to validate a webhook\nvar VALIDATION_TOKEN=process.env.MESSENGER_VALIDATION_TOKEN?process.env.MESSENGER_VALIDATION_TOKEN:_config2.default.get('VALIDATION_TOKEN');// Generate a page access token for your page from the App Dashboard\nvar PAGE_ACCESS_TOKEN=process.env.MESSENGER_PAGE_ACCESS_TOKEN?process.env.MESSENGER_PAGE_ACCESS_TOKEN:_config2.default.get('PAGE_ACCESS_TOKEN');// URL where the app is running (include protocol). Used to point to scripts and\n// assets located at this address.\nvar SERVER_URL=process.env.SERVER_URL?process.env.SERVER_URL:_config2.default.get('SERVER_URL');var FACEBOOK_APP_ID=process.env.FACEBOOK_APP_ID?process.env.FACEBOOK_APP_ID:_config2.default.get('FACEBOOK_APP_ID');var FACEBOOK_GRAPH=process.env.FACEBOOK_GRAPH?process.env.FACEBOOK_GRAPH:_config2.default.get('FACEBOOK_GRAPH');var REDIRECT_URI=process.env.REDIRECT_URI?process.env.REDIRECT_URI:_config2.default.get('REDIRECT_URI');var limit=9;if(!(APP_SECRET&&VALIDATION_TOKEN&&PAGE_ACCESS_TOKEN&&SERVER_URL)){console.error(\"Missing config values\");process.exit(1);}_server.app.use(_bodyParser2.default.json({verify:verifyRequestSignature}));//app.use(parseExpressHttpsRedirect());\n//app.use(parseExpressCookieSession({ fetchUser: true }));\nvar listener={};var buffer={};var rules=new Map();var payloadRules=new Map();/*\n * Verify that the callback came from Facebook. Using the App Secret from\n * the App Dashboard, we can verify the signature that is sent with each\n * callback in the x-hub-signature field, located in the header.\n *\n * https://developers.facebook.com/docs/graph-api/webhooks#setup\n *\n */function verifyRequestSignature(req,res,buf){var signature=req.headers[\"x-hub-signature\"];if(!signature){// For testing, let's log an error. In production, you should throw an\n// error.\nconsole.error(\"Couldn't validate the signature.\");}else{var elements=signature.split('=');var method=elements[0];var signatureHash=elements[1];//console.log(signature);\nvar expectedHash=_crypto2.default.createHmac('sha1',APP_SECRET).update(buf).digest('hex');if(signatureHash!=expectedHash){throw new Error(\"Couldn't validate the request signature.\");}}}/*\n * Authorization Event\n *\n * The value for 'optin.ref' is defined in the entry point. For the \"Send to\n * Messenger\" plugin, it is the 'data-ref' field. Read more at\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/authentication\n *\n */function receivedAuthentication(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var timeOfAuth=event.timestamp;// The 'ref' field is set in the 'Send to Messenger' plugin, in the 'data-ref'\n// The developer can set this to an arbitrary value to associate the\n// authentication callback with the 'Send to Messenger' click event. This is\n// a way to do account linking when the user clicks the 'Send to Messenger'\n// plugin.\nsenderID=parseInt(senderID);var passThroughParam=event.optin.ref;console.log(\"Received authentication for user %d and page %d with pass \"+\"through param '%s' at %d\",senderID,recipientID,passThroughParam,timeOfAuth);// When an authentication is received, we'll send a message back to the sender\n// to let them know it was successful.\nsendTextMessage(senderID,\"Authentication successful\");}/*\n * Message Event\n *\n * This event is called when a message is sent to your page. The 'message'\n * object format can lety depending on the kind of message that was received.\n * Read more at https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-received\n *\n * For this example, we're going to echo any text that we get. If we get some\n * special keywords ('button', 'generic', 'receipt'), then we'll send back\n * examples of those bubbles to illustrate the special message bubbles we've\n * created. If we receive a message with an attachment (image, video, audio),\n * then we'll simply confirm that we've received the attachment.\n *\n */function receivedMessage(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var timeOfMessage=event.timestamp;var message=event.message;//console.log(\"Received message for user %d and page %d at %d with message:\", senderID, recipientID, timeOfMessage);\n//console.log(JSON.stringify(message));\nvar isEcho=message.is_echo;var messageId=message.mid;var appId=message.app_id;var metadata=message.metadata;// You may get a text or attachment but not both\nvar messageText=message.text;var messageAttachments=message.attachments;var quickReply=message.quick_reply;senderID=parseInt(senderID);if(isEcho){// Just logging message echoes to console\nconsole.log(\"Received echo for message %s and app %d with metadata %s\",messageId,appId,metadata);return;}else if(quickReply){var quickReplyPayload=quickReply.payload;//console.log(\"Quick reply for message %s with payload %s\", messageId, quickReplyPayload);\nvar payloadFunction=void 0;if(quickReplyPayload.includes('-')){var params=quickReplyPayload.split('-');payloadFunction=payloadRules.get(params[0]);//console.log(senderID);\n//console.log(typeof senderID);\nif(typeof payloadFunction=='function'){if(params.length==4){payloadFunction(senderID,params[1],params[2],params[3]);}else if(params.length==3){payloadFunction(senderID,params[1],params[2]);}else{payloadFunction(senderID,params[1]);}}}else{payloadFunction=payloadRules.get(quickReplyPayload);if(payloadFunction){payloadFunction(senderID);}/*\n             payloadFunction = findKeyStartsWith(payloadRules, quickReplyPayload);\n             if(payloadFunction){\n             payloadFunction(senderID);\n             }*/}//sendTextMessage(senderID, \"Quick reply tapped\");\nreturn;}else if(messageText){// If we receive a text message, check to see if it matches any special\n// keywords and send back the corresponding example. Otherwise, just echo\n// the text we received.\n//Object.keys(listener);\nvar userListeners=listener[senderID];var existRule=false;//console.log(senderID);\n//console.log(typeof senderID);\nif(!_.isEmpty(userListeners)){if(!buffer[senderID]){buffer[senderID]={};}var keys=Object.keys(userListeners);var key=keys.shift();//console.log('User Listeners');\nwhile(key){//console.log(key);\nif(userListeners[key].type=='text'){buffer[senderID][key]=messageText;userListeners[key].callback(senderID);existRule=true;}delete userListeners[key];key=keys.shift();}}else{messageText=messageText.toLowerCase();rules.forEach(function(value,key){if(messageText.includes(key)){value(senderID);existRule=true;}});}if(!existRule){//console.log(messageText);\n//console.log(defaultSearch);\ndefaultSearch(senderID,messageText);}/*\n\n\n         switch (messageText) {\n         case 'image':\n         sendImageMessage(senderID);\n         break;\n\n         case 'gif':\n         sendGifMessage(senderID);\n         break;\n\n         case 'audio':\n         sendAudioMessage(senderID);\n         break;\n\n         case 'video':\n         sendVideoMessage(senderID);\n         break;\n\n         case 'file':\n         sendFileMessage(senderID);\n         break;\n\n         case 'button':\n         sendButtonMessage(senderID);\n         break;\n\n         case 'generic':\n         sendGenericMessage(senderID);\n         break;\n\n         case 'receipt':\n         sendReceiptMessage(senderID);\n         break;\n\n         case 'quick reply':\n         sendQuickReply(senderID);\n         break;\n\n         case 'read receipt':\n         sendReadReceipt(senderID);\n         break;\n\n         case 'typing on':\n         sendTypingOn(senderID);\n         break;\n\n         case 'typing off':\n         sendTypingOff(senderID);\n         break;\n\n         case 'account linking':\n         sendAccountLinking(senderID);\n         break;\n\n         default:\n         sendTextMessage(senderID, messageText);\n         }\n         /*\n         if (messageText.indexOf(\"hola\") > -1){\n         sendMenuMessage(senderID);\n         }\n         else if (messageText.indexOf(\"buenos dias\") > -1){\n         sendMenuMessage(senderID);\n         }\n         else if (messageText.indexOf(\"menu del dia\") > -1){\n         sendMenuMessage(senderID);\n         }\n         else if (messageText.indexOf(\"cuenta\") > -1){\n         sendBillMessage(senderID);\n         }\n         */}else if(messageAttachments){if(messageAttachments[0].type=='location'){var location=messageAttachments[0].payload.coordinates;var _userListeners=listener[senderID];//console.log(senderID);\n//console.log(typeof senderID);\nif(!_.isEmpty(_userListeners)){if(!buffer[senderID]){buffer[senderID]={};}var _keys=Object.keys(_userListeners);var _key=_keys.shift();while(_key){//console.log(key);\nif(_userListeners[_key].type=='attachment'){buffer[senderID][_key]={lat:location.lat,lng:location.long};_userListeners[_key].callback(senderID);}delete _userListeners[_key];_key=_keys.shift();}}}//sendTextMessage(senderID, \"Message with attachment received\");\n}}/*\n * Delivery Confirmation Event\n *\n * This event is sent to confirm the delivery of a message. Read more about\n * these fields at https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-delivered\n *\n */function receivedDeliveryConfirmation(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var delivery=event.delivery;var messageIDs=delivery.mids;var watermark=delivery.watermark;var sequenceNumber=delivery.seq;senderID=parseInt(senderID);if(messageIDs){messageIDs.forEach(function(messageID){//console.log(\"Received delivery confirmation for message ID: %s\", messageID);\n});}//console.log(\"All message before %d were delivered.\", watermark);\n}/*\n * Postback Event\n *\n * This event is called when a postback is tapped on a Structured Message.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/postback-received\n *\n */function receivedPostback(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var timeOfPostback=event.timestamp;// The 'payload' param is a developer-defined field which is set in a postback\n// button for Structured Messages.\nvar payload=event.postback.payload;//console.log(\"Received postback for user %d and page %d with payload '%s' \" + \"at %d\", senderID, recipientID, payload, timeOfPostback);\n// When a postback is called, we'll send a message back to the sender to\n// let them know it was successful\nvar payloadFunction=void 0;var params=payload.split('-');payloadFunction=payloadRules.get(params[0]);senderID=parseInt(senderID);//console.log(senderID);\n//console.log(typeof senderID);\nif(payloadFunction){switch(params.length){case 1:payloadFunction(senderID);break;case 2:payloadFunction(senderID,params[1]);break;case 3:payloadFunction(senderID,params[1],params[2]);break;default:console.log('Payload not found: '+params);}}/*\n    if(payload == 'Greeting'){\n        sendMenuMessage(senderID);\n    }\n    else if(payload == 'Delivery'){\n        sendMenuMessage(senderID);\n    }\n    else if(payload.startsWith(\"ListCategories\")){\n        let params = payload.split(\"-\");\n        console.log(\"List Categories\");\n        console.log(params);\n        listCategories(senderID, parseInt(params[1]));\n    }\n    else if(payload.startsWith(\"ListProducts\")){\n        let params = payload.split(\"-\");\n        listProducts(senderID, params[1], parseInt(params[2]));\n    }\n    else if(payload.startsWith(\"Add\")){\n        let params = payload.split(\"-\");\n        addProduct(params[1]);\n    }\n    else if(payload.startsWith(\"ShoppingCart\")){\n        sendBillMessage(senderID);\n    }\n    else{\n        sendTextMessage(senderID, \"Postback called \"+payload);\n    }\n    */}/*\n * Message Read Event\n *\n * This event is called when a previously-sent message has been read.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-read\n *\n */function receivedMessageRead(event){var senderID=event.sender.id;var recipientID=event.recipient.id;// All messages before watermark (a timestamp) or sequence have been seen.\nvar watermark=event.read.watermark;var sequenceNumber=event.read.seq;senderID=parseInt(senderID);console.log(\"Received message read event for watermark %d and sequence \"+\"number %d\",watermark,sequenceNumber);}/*\n * Account Link Event\n *\n * This event is called when the Link Account or UnLink Account action has been\n * tapped.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/account-linking\n *\n */function receivedAccountLink(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var status=event.account_linking.status;var authCode=event.account_linking.authorization_code;senderID=parseInt(senderID);console.log(\"Received account link event with for user %d with status %s \"+\"and auth code %s \",senderID,status,authCode);}/*\n * Call the Send API. The message data goes in the body. If successful, we'll\n * get the message id in a response\n *\n */function callSendAPI(messageData){return(0,_requestPromise2.default)({uri:FACEBOOK_GRAPH+'me/messages',qs:{access_token:PAGE_ACCESS_TOKEN},method:'POST',json:messageData}).catch(function(error){console.log('error');console.log(error);});}function testAPI(){return(0,_requestPromise2.default)({uri:FACEBOOK_GRAPH+'me?fields=name,email,age_range,birthday,is_verified,location',qs:{access_token:PAGE_ACCESS_TOKEN},method:'GET'}).then(function(response){console.log('Successful login for: '+response.name);console.log('Thanks for logging in, '+response.email+'!');console.log(response);}).catch(function(error){console.log('error');console.log(error);});}/*\n * Turn typing indicator on\n *\n */function sendTypingOn(recipientId){//console.log(\"Turning typing indicator on\");\nvar messageData={recipient:{id:recipientId},sender_action:\"typing_on\"};return callSendAPI(messageData);}/*\n * Turn typing indicator off\n *\n */function sendTypingOff(recipientId){//console.log(\"Turning typing indicator off\");\nvar messageData={recipient:{id:recipientId},sender_action:\"typing_off\"};return callSendAPI(messageData);}/*\n * Send a text message using the Send API.\n *\n */function sendTextMessage(recipientId,messageText){var messageData={recipient:{id:recipientId},message:{text:messageText//metadata: \"DEVELOPER_DEFINED_METADATA\"\n}};return callSendAPI(messageData);}/*\n * Send an image using the Send API.\n *\n */function sendImageMessage(recipientId,imageUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"image\",payload:{url:imageUrl}}}};return callSendAPI(messageData);}/*\n * Send a Gif using the Send API.\n *\n */function sendGifMessage(recipientId,gifUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"image\",payload:{url:SERVER_URL+gifUrl}}}};return callSendAPI(messageData);}/*\n * Send audio using the Send API.\n *\n */function sendAudioMessage(recipientId,audioUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"audio\",payload:{url:SERVER_URL+audioUrl}}}};return callSendAPI(messageData);}/*\n * Send a video using the Send API.\n *\n */function sendVideoMessage(recipientId,videoUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"video\",payload:{url:SERVER_URL+videoUrl}}}};return callSendAPI(messageData);}/*\n * Send a video using the Send API.\n *\n */function sendFileMessage(recipientId,fileUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"file\",payload:{url:SERVER_URL+fileUrl}}}};return callSendAPI(messageData);}/*\n * Send a button message using the Send API.\n *\n */function sendButtonMessage(recipientId,text,buttons){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"template\",payload:{template_type:\"button\",text:text,buttons:buttons}}}};/*\n     {\n        type: \"web_url\",\n        url: \"https://www.oculus.com/en-us/rift/\",\n        title: \"Open Web URL\"\n     }, {\n        type: \"postback\",\n        title: \"Trigger Postback\",\n        payload: \"DEVELOPED_DEFINED_PAYLOAD\"\n     }, {\n        type: \"phone_number\",\n        title: \"Call Phone Number\",\n        payload: \"+16505551234\"\n     }\n\n    * */return callSendAPI(messageData);}/*\n * Send a Structured Message (Generic Message type) using the Send API.\n *\n */function sendGenericMessage(recipientId,elements){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"template\",payload:{template_type:\"generic\",elements:elements}}}};return callSendAPI(messageData);}/*\n * Send a receipt message using the Send API.\n *\n */function sendReceiptMessage(recipientId,payload,quick_replies){// Generate a random receipt ID as the API requires a unique ID\nvar receiptId=\"order\"+Math.floor(Math.random()*1000);var messageData={recipient:{id:recipientId},message:{attachment:{type:\"template\",payload:payload},quick_replies:quick_replies}};/*\n    * {\n     template_type: \"receipt\",\n     recipient_name: \"Peter Chang\",\n     order_number: receiptId,\n     currency: \"COP\",\n     payment_method: \"Visa 1234\",\n     timestamp: \"1428444852\",\n     elements: [{\n     title: \"Oculus Rift\",\n     subtitle: \"Includes: headset, sensor, remote\",\n     quantity: 1,\n     price: 599.00,\n     currency: \"USD\",\n     image_url: SERVER_URL + \"/assets/riftsq.png\"\n     }, {\n     title: \"Samsung Gear VR\",\n     subtitle: \"Frost White\",\n     quantity: 1,\n     price: 99.99,\n     currency: \"USD\",\n     image_url: SERVER_URL + \"/assets/gearvrsq.png\"\n     }],\n     address: {\n     street_1: \"1 Hacker Way\",\n     street_2: \"\",\n     city: \"Menlo Park\",\n     postal_code: \"94025\",\n     state: \"CA\",\n     country: \"US\"\n     },\n     summary: {\n     subtotal: 698.99,\n     shipping_cost: 20.00,\n     total_tax: 57.67,\n     total_cost: 626.66\n     },\n     adjustments: [{\n     name: \"New Customer Discount\",\n     amount: -50\n     }, {\n     name: \"$100 Off Coupon\",\n     amount: -100\n     }]\n     }\n    *\n    * */return callSendAPI(messageData);}/*\n * Send a message with Quick Reply buttons.\n *\n */function sendQuickReplyMessage(recipientId,text,quick_replies){var messageData={recipient:{id:recipientId},message:{text:text,//metadata: \"DEVELOPER_DEFINED_METADATA\",\nquick_replies:quick_replies}};/*\n\n     [\n     {\n     \"content_type\":\"text\",\n     \"title\":\"Action\",\n     \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_ACTION\"\n     },\n     {\n     \"content_type\":\"text\",\n     \"title\":\"Comedy\",\n     \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_COMEDY\"\n     },\n     {\n     \"content_type\":\"text\",\n     \"title\":\"Drama\",\n     \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_DRAMA\"\n     }\n     ]\n\n    * */return callSendAPI(messageData);}/*\n * Send a read receipt to indicate the message has been read\n *\n */function sendReadReceipt(recipientId){console.log(\"Sending a read receipt to mark message as seen\");var messageData={recipient:{id:recipientId},sender_action:\"mark_seen\"};return callSendAPI(messageData);}/*\n * Send a message with the account linking call-to-action\n *\n */function sendAccountLinking(recipientId,payload){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"template\",payload:payload}}};/*\n\n     {\n     template_type: \"button\",\n     text: \"Welcome. Link your account.\",\n     buttons:[{\n     type: \"account_link\",\n     url: SERVER_URL + \"/authorize\"\n     }]\n     }\n\n    * */return callSendAPI(messageData);}function findKeyStartsWith(map,str){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=map[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _step$value=_slicedToArray(_step.value,2),key=_step$value[0],value=_step$value[1];if(key.startsWith(str))return value;}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}return undefined;}function setListener(recipientId,dataId,type,callback){if(typeof listener[recipientId]=='undefined'){listener[recipientId]={};}listener[recipientId][dataId]={callback:callback,type:type};}function getListener(recipientId,dataId){if(typeof listener[recipientId]=='undefined'){return undefined;}return listener[recipientId][dataId];}function deleteListener(recipientId,dataId){if(!listener[recipientId]){return false;}delete listener[recipientId][dataId];return true;}function setDataBuffer(recipientId,key,value){if(!buffer[recipientId]){buffer[recipientId]={};}buffer[recipientId][key]=value;}function defaultSearch(recipientId,query){//console.log('defaultSearch');\n//console.log(search);\nvar search=payloadRules.get('Search');if(search){search(recipientId,query);}};/*\n * Use your own validation token. Check that the token used in the Webhook\n * setup is the same token used here.\n *\n */_server.app.get('/webhook',function(req,res){if(req.query['hub.mode']==='subscribe'&&req.query['hub.verify_token']===VALIDATION_TOKEN){console.log(\"Validating webhook\");res.status(200).send(req.query['hub.challenge']);}else{console.error(\"Failed validation. Make sure the validation tokens match.\");res.sendStatus(403);}});/*\n * All callbacks for Messenger are POST-ed. They will be sent to the same\n * webhook. Be sure to subscribe your app to your page to receive callbacks\n * for your page.\n * https://developers.facebook.com/docs/messenger-platform/product-overview/setup#subscribe_app\n *\n */_server.app.post('/webhook',function(req,res){var data=req.body;// Make sure this is a page subscription\nif(data.object=='page'){// Iterate over each entry\n// There may be multiple if batched\ndata.entry.forEach(function(pageEntry){var pageID=pageEntry.id;var timeOfEvent=pageEntry.time;// Iterate over each messaging event\npageEntry.messaging.forEach(function(messagingEvent){//console.log(messagingEvent);\nif(messagingEvent.optin){receivedAuthentication(messagingEvent);}else if(messagingEvent.message){receivedMessage(messagingEvent);}else if(messagingEvent.delivery){receivedDeliveryConfirmation(messagingEvent);}else if(messagingEvent.postback){receivedPostback(messagingEvent);}else if(messagingEvent.read){receivedMessageRead(messagingEvent);}else if(messagingEvent.account_linking){receivedAccountLink(messagingEvent);}else{console.log(\"Webhook received unknown messagingEvent: \",messagingEvent);}});});// Assume all went well.\n//\n// You must send back a 200, within 20 seconds, to let us know you've\n// successfully received the callback. Otherwise, the request will time out.\nres.sendStatus(200);}});/*\n * This path is used for account linking. The account linking call-to-action\n * (sendAccountLinking) is pointed to this URL.\n *\n */_server.app.get('/authorize',function(req,res){var accountLinkingToken=req.query['account_linking_token'];var redirectURI=req.query['redirect_uri'];// Authorization Code should be generated per user by the developer. This will\n// be passed to the Account Linking callback.\nvar authCode=\"1234567890\";// Redirect users to this URI on successful login\nvar redirectURISuccess=redirectURI+\"&authorization_code=\"+authCode;res.render('authorize',{accountLinkingToken:accountLinkingToken,redirectURI:redirectURI,redirectURISuccess:redirectURISuccess});});// Start server\n// Webhooks must be available via SSL with a certificate signed by a valid\n// certificate authority.\n_server.app.listen(_server.app.get('port'),function(){//console.log('Node app is running on port', app.get('port'));\n});module.exports={app:_server.app,Parse:_server.Parse,rules:rules,payloadRules:payloadRules,buffer:buffer,listener:listener,limit:limit,defaultSearch:defaultSearch,callSendAPI:callSendAPI,sendTypingOn:sendTypingOn,sendTypingOff:sendTypingOff,sendTextMessage:sendTextMessage,sendQuickReplyMessage:sendQuickReplyMessage,sendImageMessage:sendImageMessage,sendGifMessage:sendGifMessage,sendAudioMessage:sendAudioMessage,sendVideoMessage:sendVideoMessage,sendFileMessage:sendFileMessage,sendButtonMessage:sendButtonMessage,sendGenericMessage:sendGenericMessage,sendReceiptMessage:sendReceiptMessage,setListener:setListener,getListener:getListener,deleteListener:deleteListener,setDataBuffer:setDataBuffer,testAPI:testAPI};"]}