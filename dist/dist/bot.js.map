{"version":3,"sources":["../bot.js"],"names":["_slicedToArray","sliceIterator","arr","i","_arr","_n","_d","_e","undefined","_i","Symbol","iterator","_s","next","done","push","value","length","err","Array","isArray","Object","TypeError","_server","require","_bodyParser","_bodyParser2","_interopRequireDefault","_config","_config2","_crypto","_crypto2","_underscore","_","_interopRequireWildcard","_requestPromise","_requestPromise2","obj","__esModule","newObj","key","prototype","hasOwnProperty","call","default","APP_SECRET","process","env","MESSENGER_APP_SECRET","get","VALIDATION_TOKEN","MESSENGER_VALIDATION_TOKEN","SERVER_URL","FACEBOOK_GRAPH","COMMERCES","limit","console","error","exit","app","use","json","verify","verifyRequestSignature","listener","buffer","rules","Map","payloadRules","req","res","buf","signature","headers","elements","split","method","signatureHash","expectedHash","createHmac","update","digest","Error","receivedAuthentication","event","senderID","sender","id","recipientID","recipient","timeOfAuth","timestamp","parseInt","passThroughParam","optin","ref","log","sendTextMessage","receivedMessage","timeOfMessage","message","isEcho","is_echo","messageId","mid","appId","app_id","metadata","messageText","text","messageAttachments","attachments","quickReply","quick_reply","quickReplyPayload","payload","payloadFunction","includes","params","userListeners","existRule","isEmpty","keys","shift","type","callback","toLowerCase","forEach","func","defaultSearch","location","coordinates","_userListeners","_keys","_key","lat","lng","long","receivedDeliveryConfirmation","delivery","messageIDs","mids","watermark","sequenceNumber","seq","messageID","receivedPostback","timeOfPostback","postback","receivedMessageRead","read","receivedAccountLink","status","account_linking","authCode","authorization_code","callSendAPI","messageData","senderId","uri","qs","access_token","PAGE_ACCESS_TOKEN","catch","testAPI","then","response","name","email","sendTypingOn","recipientId","sender_action","sendTypingOff","sendImageMessage","imageUrl","attachment","url","sendGifMessage","gifUrl","sendAudioMessage","audioUrl","sendVideoMessage","videoUrl","sendFileMessage","fileUrl","sendButtonMessage","buttons","template_type","sendGenericMessage","sendReceiptMessage","quick_replies","receiptId","Math","floor","random","sendQuickReplyMessage","sendReadReceipt","sendAccountLinking","findKeyStartsWith","map","str","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_iterator","_step","_step$value","startsWith","return","setListener","dataId","getListener","deleteListener","setDataBuffer","query","search","send","sendStatus","post","data","body","object","entry","pageEntry","pageID","timeOfEvent","time","messaging","messagingEvent","accountLinkingToken","redirectURI","redirectURISuccess","render","listen","module","exports","Parse"],"mappings":"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","file":"bot.js","sourcesContent":["'use strict';var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i[\"return\"])_i[\"return\"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError(\"Invalid attempt to destructure non-iterable instance\");}};}();var _server=require('./server');var _bodyParser=require('body-parser');var _bodyParser2=_interopRequireDefault(_bodyParser);var _config=require('config');var _config2=_interopRequireDefault(_config);var _crypto=require('crypto');var _crypto2=_interopRequireDefault(_crypto);var _underscore=require('underscore');var _=_interopRequireWildcard(_underscore);var _requestPromise=require('request-promise');var _requestPromise2=_interopRequireDefault(_requestPromise);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var APP_SECRET=process.env.MESSENGER_APP_SECRET?process.env.MESSENGER_APP_SECRET:_config2.default.get('APP_SECRET');var VALIDATION_TOKEN=process.env.MESSENGER_VALIDATION_TOKEN?process.env.MESSENGER_VALIDATION_TOKEN:_config2.default.get('VALIDATION_TOKEN');var SERVER_URL=process.env.SERVER_URL?process.env.SERVER_URL:_config2.default.get('SERVER_URL');var FACEBOOK_GRAPH=process.env.FACEBOOK_GRAPH?process.env.FACEBOOK_GRAPH:_config2.default.get('FACEBOOK_GRAPH');var COMMERCES=_config2.default.get('COMMERCES');var limit=9;if(!(APP_SECRET&&VALIDATION_TOKEN&&COMMERCES&&SERVER_URL)){console.error(\"Missing config values\");process.exit(1);}_server.app.use(_bodyParser2.default.json({verify:verifyRequestSignature}));//app.use(parseExpressHttpsRedirect());\n//app.use(parseExpressCookieSession({ fetchUser: true }));\nvar listener={};var buffer={};var rules=new Map();var payloadRules=new Map();/*\n * Verify that the callback came from Facebook. Using the App Secret from\n * the App Dashboard, we can verify the signature that is sent with each\n * callback in the x-hub-signature field, located in the header.\n *\n * https://developers.facebook.com/docs/graph-api/webhooks#setup\n *\n */function verifyRequestSignature(req,res,buf){var signature=req.headers[\"x-hub-signature\"];if(!signature){// For testing, let's log an error. In production, you should throw an\n// error.\nconsole.error(\"Couldn't validate the signature.\");}else{var elements=signature.split('=');var method=elements[0];var signatureHash=elements[1];//console.log(signature);\nvar expectedHash=_crypto2.default.createHmac('sha1',APP_SECRET).update(buf).digest('hex');if(signatureHash!=expectedHash){throw new Error(\"Couldn't validate the request signature.\");}}}/*\n * Authorization Event\n *\n * The value for 'optin.ref' is defined in the entry point. For the \"Send to\n * Messenger\" plugin, it is the 'data-ref' field. Read more at\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/authentication\n *\n */function receivedAuthentication(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var timeOfAuth=event.timestamp;// The 'ref' field is set in the 'Send to Messenger' plugin, in the 'data-ref'\n// The developer can set this to an arbitrary value to associate the\n// authentication callback with the 'Send to Messenger' click event. This is\n// a way to do account linking when the user clicks the 'Send to Messenger'\n// plugin.\nsenderID=parseInt(senderID);recipientID=parseInt(recipientID);var passThroughParam=event.optin.ref;console.log(\"Received authentication for user %d and page %d with pass \"+\"through param '%s' at %d\",senderID,recipientID,passThroughParam,timeOfAuth);// When an authentication is received, we'll send a message back to the sender\n// to let them know it was successful.\nsendTextMessage(senderID,recipientID,\"Authentication successful\");}/*\n * Message Event\n *\n * This event is called when a message is sent to your page. The 'message'\n * object format can lety depending on the kind of message that was received.\n * Read more at https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-received\n *\n * For this example, we're going to echo any text that we get. If we get some\n * special keywords ('button', 'generic', 'receipt'), then we'll send back\n * examples of those bubbles to illustrate the special message bubbles we've\n * created. If we receive a message with an attachment (image, video, audio),\n * then we'll simply confirm that we've received the attachment.\n *\n */function receivedMessage(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var timeOfMessage=event.timestamp;var message=event.message;//console.log(\"Received message for user %d and page %d at %d with message:\", senderID, recipientID, timeOfMessage);\n//console.log(JSON.stringify(message));\nvar isEcho=message.is_echo;var messageId=message.mid;var appId=message.app_id;var metadata=message.metadata;// You may get a text or attachment but not both\nvar messageText=message.text;var messageAttachments=message.attachments;var quickReply=message.quick_reply;senderID=parseInt(senderID);recipientID=parseInt(recipientID);if(isEcho){// Just logging message echoes to console\nconsole.log(\"Received echo for message %s and app %d with metadata %s\",messageId,appId,metadata);return;}else if(quickReply){var quickReplyPayload=quickReply.payload;//console.log(\"Quick reply for message %s with payload %s\", messageId, quickReplyPayload);\nvar payloadFunction=void 0;if(quickReplyPayload.includes('-')){var params=quickReplyPayload.split('-');payloadFunction=payloadRules.get(params[0]);//console.log(senderID);\n//console.log(typeof senderID);\nif(typeof payloadFunction=='function'){if(params.length==4){payloadFunction(senderID,recipientID,params[1],params[2],params[3]);}else if(params.length==3){payloadFunction(senderID,recipientID,params[1],params[2]);}else{payloadFunction(senderID,recipientID,params[1]);}}}else{payloadFunction=payloadRules.get(quickReplyPayload);if(payloadFunction){payloadFunction(senderID,recipientID);}//payloadFunction = findKeyStartsWith(payloadRules, quickReplyPayload);\n//if(payloadFunction){\n//payloadFunction(senderID, recipientID);\n//}\n}//sendTextMessage(senderID, \"Quick reply tapped\");\nreturn;}else if(messageText){// If we receive a text message, check to see if it matches any special\n// keywords and send back the corresponding example. Otherwise, just echo\n// the text we received.\n//Object.keys(listener);\nvar userListeners=listener[senderID];var existRule=false;//console.log(senderID);\n//console.log(typeof senderID);\nif(!_.isEmpty(userListeners)){if(!buffer[senderID]){buffer[senderID]={};}var keys=Object.keys(userListeners);var key=keys.shift();//console.log('User Listeners');\nwhile(key){//console.log(key);\nif(userListeners[key].type=='text'){buffer[senderID][key]=messageText;userListeners[key].callback(senderID,recipientID);existRule=true;}delete userListeners[key];key=keys.shift();}}else{messageText=messageText.toLowerCase();rules.forEach(function(func,key){if(messageText.includes(key)){func(senderID,recipientID);existRule=true;}});}if(!existRule){//console.log(messageText);\n//console.log(defaultSearch);\ndefaultSearch(senderID,recipientID,messageText);}}else if(messageAttachments){if(messageAttachments[0].type=='location'){var location=messageAttachments[0].payload.coordinates;var _userListeners=listener[senderID];//console.log(senderID);\n//console.log(typeof senderID);\nif(!_.isEmpty(_userListeners)){if(!buffer[senderID]){buffer[senderID]={};}var _keys=Object.keys(_userListeners);var _key=_keys.shift();while(_key){//console.log(key);\nif(_userListeners[_key].type=='attachment'){buffer[senderID][_key]={lat:location.lat,lng:location.long};_userListeners[_key].callback(senderID,recipientID);}delete _userListeners[_key];_key=_keys.shift();}}}//sendTextMessage(senderID, \"Message with attachment received\");\n}}/*\n * Delivery Confirmation Event\n *\n * This event is sent to confirm the delivery of a message. Read more about\n * these fields at https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-delivered\n *\n */function receivedDeliveryConfirmation(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var delivery=event.delivery;var messageIDs=delivery.mids;var watermark=delivery.watermark;var sequenceNumber=delivery.seq;senderID=parseInt(senderID);recipientID=parseInt(recipientID);if(messageIDs){messageIDs.forEach(function(messageID){//console.log(\"Received delivery confirmation for message ID: %s\", messageID);\n});}//console.log(\"All message before %d were delivered.\", watermark);\n}/*\n * Postback Event\n *\n * This event is called when a postback is tapped on a Structured Message.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/postback-received\n *\n */function receivedPostback(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var timeOfPostback=event.timestamp;// The 'payload' param is a developer-defined field which is set in a postback\n// button for Structured Messages.\nvar payload=event.postback.payload;//console.log(\"Received postback for user %d and page %d with payload '%s' \" + \"at %d\", senderID, recipientID, payload, timeOfPostback);\n// When a postback is called, we'll send a message back to the sender to\n// let them know it was successful\nvar payloadFunction=void 0;var params=payload.split('-');payloadFunction=payloadRules.get(params[0]);senderID=parseInt(senderID);recipientID=parseInt(recipientID);//console.log(senderID);\n//console.log(typeof senderID);\nif(payloadFunction){switch(params.length){case 1:payloadFunction(senderID,recipientID);break;case 2:payloadFunction(senderID,recipientID,params[1]);break;case 3:payloadFunction(senderID,recipientID,params[1],params[2]);break;default:console.log('Payload not found: '+params);}}/*\n    if(payload == 'Greeting'){\n        sendMenuMessage(senderID);\n    }\n    else if(payload == 'Delivery'){\n        sendMenuMessage(senderID);\n    }\n    else if(payload.startsWith(\"ListCategories\")){\n        let params = payload.split(\"-\");\n        console.log(\"List Categories\");\n        console.log(params);\n        listCategories(senderID, parseInt(params[1]));\n    }\n    else if(payload.startsWith(\"ListProducts\")){\n        let params = payload.split(\"-\");\n        listProducts(senderID, params[1], parseInt(params[2]));\n    }\n    else if(payload.startsWith(\"Add\")){\n        let params = payload.split(\"-\");\n        addProduct(params[1]);\n    }\n    else if(payload.startsWith(\"ShoppingCart\")){\n        sendBillMessage(senderID);\n    }\n    else{\n        sendTextMessage(senderID, \"Postback called \"+payload);\n    }\n    */}/*\n * Message Read Event\n *\n * This event is called when a previously-sent message has been read.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/message-read\n *\n */function receivedMessageRead(event){var senderID=event.sender.id;var recipientID=event.recipient.id;// All messages before watermark (a timestamp) or sequence have been seen.\nvar watermark=event.read.watermark;var sequenceNumber=event.read.seq;senderID=parseInt(senderID);recipientID=parseInt(recipientID);console.log(\"Received message read event for watermark %d and sequence \"+\"number %d\",watermark,sequenceNumber);}/*\n * Account Link Event\n *\n * This event is called when the Link Account or UnLink Account action has been\n * tapped.\n * https://developers.facebook.com/docs/messenger-platform/webhook-reference/account-linking\n *\n */function receivedAccountLink(event){var senderID=event.sender.id;var recipientID=event.recipient.id;var status=event.account_linking.status;var authCode=event.account_linking.authorization_code;senderID=parseInt(senderID);recipientID=parseInt(recipientID);console.log(\"Received account link event with for user %d with status %s \"+\"and auth code %s \",senderID,status,authCode);}/*\n * Call the Send API. The message data goes in the body. If successful, we'll\n * get the message id in a response\n *\n */function callSendAPI(messageData,senderId){if(COMMERCES.hasOwnProperty(senderId)){return(0,_requestPromise2.default)({uri:FACEBOOK_GRAPH+'me/messages',qs:{access_token:COMMERCES[senderId].PAGE_ACCESS_TOKEN},method:'POST',json:messageData}).catch(function(error){console.log('error');console.log(error);});}else{console.log('Error: senderId not found: '+senderId);console.log(messageData);}}function testAPI(senderId){return(0,_requestPromise2.default)({uri:FACEBOOK_GRAPH+'me?fields=name,email,age_range,birthday,is_verified,location',qs:{access_token:COMMERCES[senderId].PAGE_ACCESS_TOKEN},method:'GET'}).then(function(response){console.log('Successful login for: '+response.name);console.log('Thanks for logging in, '+response.email+'!');console.log(response);}).catch(function(error){console.log('error');console.log(error);});}/*\n * Turn typing indicator on\n *\n */function sendTypingOn(recipientId,senderId){//console.log(\"Turning typing indicator on\");\nvar messageData={recipient:{id:recipientId},sender_action:\"typing_on\"};return callSendAPI(messageData,senderId);}/*\n * Turn typing indicator off\n *\n */function sendTypingOff(recipientId,senderId){//console.log(\"Turning typing indicator off\");\nvar messageData={recipient:{id:recipientId},sender_action:\"typing_off\"};return callSendAPI(messageData,senderId);}/*\n * Send a text message using the Send API.\n *\n */function sendTextMessage(recipientId,senderId,messageText){var messageData={recipient:{id:recipientId},message:{text:messageText//metadata: \"DEVELOPER_DEFINED_METADATA\"\n}};return callSendAPI(messageData,senderId);}/*\n * Send an image using the Send API.\n *\n */function sendImageMessage(recipientId,senderId,imageUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"image\",payload:{url:imageUrl}}}};return callSendAPI(messageData,senderId);}/*\n * Send a Gif using the Send API.\n *\n */function sendGifMessage(recipientId,senderId,gifUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"image\",payload:{url:SERVER_URL+gifUrl}}}};return callSendAPI(messageData,senderId);}/*\n * Send audio using the Send API.\n *\n */function sendAudioMessage(recipientId,senderId,audioUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"audio\",payload:{url:SERVER_URL+audioUrl}}}};return callSendAPI(messageData,senderId);}/*\n * Send a video using the Send API.\n *\n */function sendVideoMessage(recipientId,senderId,videoUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"video\",payload:{url:SERVER_URL+videoUrl}}}};return callSendAPI(messageData,senderId);}/*\n * Send a video using the Send API.\n *\n */function sendFileMessage(recipientId,senderId,fileUrl){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"file\",payload:{url:SERVER_URL+fileUrl}}}};return callSendAPI(messageData,senderId);}/*\n * Send a button message using the Send API.\n *\n */function sendButtonMessage(recipientId,senderId,text,buttons){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"template\",payload:{template_type:\"button\",text:text,buttons:buttons}}}};/*\n     {\n        type: \"web_url\",\n        url: \"https://www.oculus.com/en-us/rift/\",\n        title: \"Open Web URL\"\n     }, {\n        type: \"postback\",\n        title: \"Trigger Postback\",\n        payload: \"DEVELOPED_DEFINED_PAYLOAD\"\n     }, {\n        type: \"phone_number\",\n        title: \"Call Phone Number\",\n        payload: \"+16505551234\"\n     }\n\n    * */return callSendAPI(messageData,senderId);}/*\n * Send a Structured Message (Generic Message type) using the Send API.\n *\n */function sendGenericMessage(recipientId,senderId,elements){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"template\",payload:{template_type:\"generic\",elements:elements}}}};return callSendAPI(messageData,senderId);}/*\n * Send a receipt message using the Send API.\n *\n */function sendReceiptMessage(recipientId,senderId,payload,quick_replies){// Generate a random receipt ID as the API requires a unique ID\nvar receiptId=\"order\"+Math.floor(Math.random()*1000);var messageData={recipient:{id:recipientId},message:{attachment:{type:\"template\",payload:payload},quick_replies:quick_replies}};/*\n    * {\n     template_type: \"receipt\",\n     recipient_name: \"Peter Chang\",\n     order_number: receiptId,\n     currency: \"COP\",\n     payment_method: \"Visa 1234\",\n     timestamp: \"1428444852\",\n     elements: [{\n     title: \"Oculus Rift\",\n     subtitle: \"Includes: headset, sensor, remote\",\n     quantity: 1,\n     price: 599.00,\n     currency: \"USD\",\n     image_url: SERVER_URL + \"/assets/riftsq.png\"\n     }, {\n     title: \"Samsung Gear VR\",\n     subtitle: \"Frost White\",\n     quantity: 1,\n     price: 99.99,\n     currency: \"USD\",\n     image_url: SERVER_URL + \"/assets/gearvrsq.png\"\n     }],\n     address: {\n     street_1: \"1 Hacker Way\",\n     street_2: \"\",\n     city: \"Menlo Park\",\n     postal_code: \"94025\",\n     state: \"CA\",\n     country: \"US\"\n     },\n     summary: {\n     subtotal: 698.99,\n     shipping_cost: 20.00,\n     total_tax: 57.67,\n     total_cost: 626.66\n     },\n     adjustments: [{\n     name: \"New Customer Discount\",\n     amount: -50\n     }, {\n     name: \"$100 Off Coupon\",\n     amount: -100\n     }]\n     }\n    *\n    * */return callSendAPI(messageData,senderId);}/*\n * Send a message with Quick Reply buttons.\n *\n */function sendQuickReplyMessage(recipientId,senderId,text,quick_replies){var messageData={recipient:{id:recipientId},message:{text:text,//metadata: \"DEVELOPER_DEFINED_METADATA\",\nquick_replies:quick_replies}};/*\n\n     [\n     {\n     \"content_type\":\"text\",\n     \"title\":\"Action\",\n     \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_ACTION\"\n     },\n     {\n     \"content_type\":\"text\",\n     \"title\":\"Comedy\",\n     \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_COMEDY\"\n     },\n     {\n     \"content_type\":\"text\",\n     \"title\":\"Drama\",\n     \"payload\":\"DEVELOPER_DEFINED_PAYLOAD_FOR_PICKING_DRAMA\"\n     }\n     ]\n\n    * */return callSendAPI(messageData,senderId);}/*\n * Send a read receipt to indicate the message has been read\n *\n */function sendReadReceipt(recipientId,senderId){console.log(\"Sending a read receipt to mark message as seen\");var messageData={recipient:{id:recipientId},sender_action:\"mark_seen\"};return callSendAPI(messageData,senderId);}/*\n * Send a message with the account linking call-to-action\n *\n */function sendAccountLinking(recipientId,senderId,payload){var messageData={recipient:{id:recipientId},message:{attachment:{type:\"template\",payload:payload}}};/*\n\n     {\n     template_type: \"button\",\n     text: \"Welcome. Link your account.\",\n     buttons:[{\n     type: \"account_link\",\n     url: SERVER_URL + \"/authorize\"\n     }]\n     }\n\n    * */return callSendAPI(messageData,senderId);}function findKeyStartsWith(map,str){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=map[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _step$value=_slicedToArray(_step.value,2),key=_step$value[0],value=_step$value[1];if(key.startsWith(str))return value;}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}return undefined;}function setListener(recipientId,dataId,type,callback){if(typeof listener[recipientId]=='undefined'){listener[recipientId]={};}listener[recipientId][dataId]={callback:callback,type:type};}function getListener(recipientId,dataId){if(typeof listener[recipientId]=='undefined'){return undefined;}return listener[recipientId][dataId];}function deleteListener(recipientId,dataId){if(!listener[recipientId]){return false;}delete listener[recipientId][dataId];return true;}function setDataBuffer(recipientId,key,value){if(!buffer[recipientId]){buffer[recipientId]={};}buffer[recipientId][key]=value;}function defaultSearch(recipientId,query){//console.log('defaultSearch');\n//console.log(search);\nvar search=payloadRules.get('Search');if(search){search(recipientId,query);}};/*\n * Use your own validation token. Check that the token used in the Webhook\n * setup is the same token used here.\n *\n */_server.app.get('/webhook',function(req,res){if(req.query['hub.mode']==='subscribe'&&req.query['hub.verify_token']===VALIDATION_TOKEN){console.log(\"Validating webhook\");res.status(200).send(req.query['hub.challenge']);}else{console.error(\"Failed validation. Make sure the validation tokens match.\");res.sendStatus(403);}});/*\n * All callbacks for Messenger are POST-ed. They will be sent to the same\n * webhook. Be sure to subscribe your app to your page to receive callbacks\n * for your page.\n * https://developers.facebook.com/docs/messenger-platform/product-overview/setup#subscribe_app\n *\n */_server.app.post('/webhook',function(req,res){var data=req.body;// Make sure this is a page subscription\nif(data.object=='page'){// Iterate over each entry\n// There may be multiple if batched\ndata.entry.forEach(function(pageEntry){var pageID=pageEntry.id;var timeOfEvent=pageEntry.time;// Iterate over each messaging event\npageEntry.messaging.forEach(function(messagingEvent){//console.log(messagingEvent);\nif(messagingEvent.optin){receivedAuthentication(messagingEvent);}else if(messagingEvent.message){receivedMessage(messagingEvent);}else if(messagingEvent.delivery){receivedDeliveryConfirmation(messagingEvent);}else if(messagingEvent.postback){receivedPostback(messagingEvent);}else if(messagingEvent.read){receivedMessageRead(messagingEvent);}else if(messagingEvent.account_linking){receivedAccountLink(messagingEvent);}else{console.log(\"Webhook received unknown messagingEvent: \",messagingEvent);}});});// Assume all went well.\n//\n// You must send back a 200, within 20 seconds, to let us know you've\n// successfully received the callback. Otherwise, the request will time out.\nres.sendStatus(200);}});/*\n * This path is used for account linking. The account linking call-to-action\n * (sendAccountLinking) is pointed to this URL.\n *\n */_server.app.get('/authorize',function(req,res){var accountLinkingToken=req.query['account_linking_token'];var redirectURI=req.query['redirect_uri'];// Authorization Code should be generated per user by the developer. This will\n// be passed to the Account Linking callback.\nvar authCode=\"1234567890\";// Redirect users to this URI on successful login\nvar redirectURISuccess=redirectURI+\"&authorization_code=\"+authCode;res.render('authorize',{accountLinkingToken:accountLinkingToken,redirectURI:redirectURI,redirectURISuccess:redirectURISuccess});});// Start server\n// Webhooks must be available via SSL with a certificate signed by a valid\n// certificate authority.\n_server.app.listen(_server.app.get('port'),function(){//console.log('Node app is running on port', app.get('port'));\n});module.exports={app:_server.app,Parse:_server.Parse,rules:rules,payloadRules:payloadRules,buffer:buffer,listener:listener,limit:limit,defaultSearch:defaultSearch,callSendAPI:callSendAPI,sendTypingOn:sendTypingOn,sendTypingOff:sendTypingOff,sendTextMessage:sendTextMessage,sendQuickReplyMessage:sendQuickReplyMessage,sendImageMessage:sendImageMessage,sendGifMessage:sendGifMessage,sendAudioMessage:sendAudioMessage,sendVideoMessage:sendVideoMessage,sendFileMessage:sendFileMessage,sendButtonMessage:sendButtonMessage,sendGenericMessage:sendGenericMessage,sendReceiptMessage:sendReceiptMessage,setListener:setListener,getListener:getListener,deleteListener:deleteListener,setDataBuffer:setDataBuffer,testAPI:testAPI};"]}